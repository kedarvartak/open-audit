generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  ADMIN
  ORGANIZER
  VERIFIER
  DONOR
}

enum ProjectStatus {
  DRAFT
  FUNDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  VERIFIED
  APPROVED
  REJECTED
}

enum ProofStatus {
  PENDING
  AI_ANALYZING
  AI_APPROVED
  AI_FLAGGED
  HUMAN_REVIEW
  VERIFIED
  REJECTED
}

enum VoteType {
  APPROVE
  REJECT
}

// ==================== MODELS ====================

model User {
  id              String          @id @default(uuid())
  email           String          @unique
  password        String
  name            String
  role            Role            @default(DONOR)
  
  // Relations
  organizedProjects Project[]       @relation("Organizer")
  verifications     Verification[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([email])
  @@index([role])
}

model Project {
  id                String         @id @default(uuid())
  title             String
  description       String
  fundingGoal       Float          // Amount in INR
  deadline          DateTime
  status            ProjectStatus  @default(DRAFT)
  
  // Blockchain
  contractAddress   String?        // Deployed smart contract address
  
  // Relations
  organizerId       String
  organizer         User           @relation("Organizer", fields: [organizerId], references: [id])
  milestones        Milestone[]
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([organizerId])
  @@index([status])
}

model Milestone {
  id                String            @id @default(uuid())
  projectId         String
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title             String
  description       String
  requiredApprovals Int               @default(3) // N-of-M voting threshold
  status            MilestoneStatus   @default(PENDING)
  
  // Blockchain
  blockchainMilestoneId Int?         // ID from smart contract
  
  // Relations
  proofs            Proof[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([projectId])
  @@index([status])
}

model Proof {
  id                String          @id @default(uuid())
  milestoneId       String
  milestone         Milestone       @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  
  // Before Image
  beforeImageUrl    String
  beforeImageHash   String          // SHA-256 hash
  
  // After Image
  afterImageUrl     String
  afterImageHash    String          // SHA-256 hash
  
  // Metadata
  gpsLatitude       Float
  gpsLongitude      Float
  location          String?         // Human-readable address
  timestamp         DateTime
  deviceInfo        String?
  
  // Status
  status            ProofStatus     @default(PENDING)
  
  // AI Analysis
  aiAnalysis        Json?           // Stores AI verification result
  aiConfidence      Float?
  aiStatus          String?         // "PASS", "FLAG", "FAIL"
  
  // Blockchain
  blockchainProofId Int?            // ID from smart contract
  transactionHash   String?         // Blockchain tx hash
  
  // Relations
  verifications     Verification[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([milestoneId])
  @@index([status])
}

model Verification {
  id            String      @id @default(uuid())
  proofId       String
  proof         Proof       @relation(fields: [proofId], references: [id], onDelete: Cascade)
  
  verifierId    String
  verifier      User        @relation(fields: [verifierId], references: [id])
  
  vote          VoteType
  comment       String?
  
  // Blockchain
  transactionHash String?   // Blockchain vote tx hash
  
  createdAt     DateTime    @default(now())

  @@unique([proofId, verifierId]) // One vote per verifier per proof
  @@index([proofId])
  @@index([verifierId])
}
