generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  CLIENT  // Posts tasks and pays
  WORKER  // Completes tasks
  ADMIN   // Resolves disputes
}

enum TaskStatus {
  OPEN           // Posted, awaiting worker
  ACCEPTED       // Worker claimed it
  IN_PROGRESS    // Before image uploaded, work started
  SUBMITTED      // After image uploaded, AI verifying
  VERIFIED       // AI approved
  PAID           // Funds released to worker
  DISPUTED       // Client disputed
  CANCELLED      // Task cancelled
}

// ==================== MODELS ====================

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  password        String
  name            String
  role            Role
  
  // Wallet & Payment
  walletAddress   String?  @unique  // For blockchain audit trail
  stripeAccountId String?  @unique  // For receiving payments (workers)
  
  // Reputation
  rating          Float    @default(0)
  completedTasks  Int      @default(0)
  
  // Firebase Cloud Messaging for push notifications
  fcmToken        String?
  
  // Relations
  clientTasks     Task[]   @relation("ClientTasks")
  workerTasks     Task[]   @relation("WorkerTasks")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([stripeAccountId])
}

model Task {
  id              String     @id @default(uuid())
  title           String
  description     String
  category        String     // "repair", "cleaning", "delivery", etc.
  budget          Float      // Amount in INR
  
  // Parties
  clientId        String
  client          User       @relation("ClientTasks", fields: [clientId], references: [id])
  workerId        String?
  worker          User?      @relation("WorkerTasks", fields: [workerId], references: [id])
  
  // Status
  status          TaskStatus @default(OPEN)
  
  // Blockchain (Audit Trail Only - No Crypto)
  contractAddress String?    // Not used for payments, just audit
  blockchainTaskId String?   // Task ID hash on blockchain
  
  // Payment (Stripe - Real INR)
  stripePaymentIntentId String?  // Stripe escrow
  stripeTransferId      String?  // Stripe payment to worker
  
  // Work Evidence
  beforeImageUrl  String?
  beforeImageHash String?    // SHA-256 for blockchain verification
  afterImageUrl   String?
  afterImageHash  String?    // SHA-256 for blockchain verification
  
  // AI Verification
  aiVerification  Json?      // Full AI result (confidence, verdict, etc.)
  aiConfidence    Float?
  aiVerdict       String?    // "FIXED" or "NOT_FIXED"
  
  // Location Verification (Google Maps)
  requiresLocation Boolean   @default(false)
  locationLat      Float?
  locationLng      Float?
  locationRadius   Int?      // meters
  locationName     String?   // "123 Main St, City"
  workerStartLat   Float?    // Worker's location when starting
  workerStartLng   Float?
  locationVerified Boolean   @default(false)
  
  // Dispute
  disputed        Boolean    @default(false)
  disputeReason   String?
  disputedAt      DateTime?
  disputeDeadline DateTime?  // 24h from completion
  
  // Timestamps
  createdAt       DateTime   @default(now())
  acceptedAt      DateTime?
  completedAt     DateTime?
  paidAt          DateTime?
  updatedAt       DateTime   @updatedAt

  @@index([clientId])
  @@index([workerId])
  @@index([status])
  @@index([category])
}
